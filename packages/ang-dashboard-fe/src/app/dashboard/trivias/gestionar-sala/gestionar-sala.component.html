<!-- eslint-disable @angular-eslint/template/elements-content -->
<div class="gestionar-sala-container">
  <p-toast></p-toast>
  
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h2 class="page-title">Gestión de Sala</h2>
        <p class="page-subtitle" *ngIf="trivia">{{ trivia?.title }}</p>
      </div>
      <div class="header-actions">
        <button 
          pButton 
          label="Volver" 
          icon="pi pi-arrow-left"
          class="custom-bordo-button"
          (click)="routerPublic.navigate(['/dashboard'])"
        ></button>
      </div>
    </div>
  </div>

  <!-- Estado de la trivia -->
  <p-card header="Información de la Trivia" class="info-card">
    <div class="info-grid">
      <div class="info-section">
        <div class="info-item">
          <span class="info-label">Estado:</span>
          <p-tag 
            [value]="roomState?.isActive ? 'Activa' : 'Inactiva'" 
            [severity]="roomState?.isActive ? 'success' : 'warn'"
          ></p-tag>
        </div>
        <div class="info-item">
          <span class="info-label">Preguntas:</span>
          <span class="info-value">{{ trivia?.questions?.length || 0 }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Room ID:</span>
          <span class="room-id" *ngIf="roomState?.isActive">{{ roomId }}</span>
          <span class="room-id inactive" *ngIf="!roomState?.isActive">--- (Sala inactiva)</span>
        </div>
      </div>
      <div class="actions-section">
        <button 
          pButton 
          [label]="roomState?.isActive ? 'Desactivar Sala' : 'Activar Sala'" 
          [icon]="roomState?.isActive ? 'pi pi-times' : 'pi pi-check'"
          class="p-button-outlined action-btn"
          (click)="toggleRoomActivation()"
          [disabled]="!roomId || isActivating"
        >
          <i *ngIf="isActivating" class="pi pi-spin pi-spinner mr-2"></i>
          {{ isActivating ? (roomState?.isActive ? 'Desactivando...' : 'Activando...') : (roomState?.isActive ? 'Desactivar Sala' : 'Activar Sala') }}
        </button>
        <button 
          pButton 
          label="Código Sala" 
          icon="pi pi-qrcode"
          class="p-button-outlined custom-bordo-button"
          (click)="showQRCode()"
          [disabled]="!roomState?.isActive || !roomId"
        ></button>
        <button 
          pButton 
          label="Iniciar Partida" 
          icon="pi pi-play"
          class="p-button-outlined custom-bordo-button"
          (click)="startGame()"
          [disabled]="!roomState?.isActive || playersCount === 0 || roomState?.isActive"
        ></button>
       
      </div>
    </div>
  </p-card>

  <!-- Jugadores conectados -->
  <p-card header="Jugadores Conectados" class="players-card">
    <div class="players-section">
      <div class="players-header">
        <span class="section-label">Total:</span>
        <p-tag [value]="playersCount.toString()" severity="info"></p-tag>
      </div>
      
      <div class="players-list">
        <div *ngFor="let player of getPlayers(); let i = index; trackBy: trackByPlayerId" class="player-item">
          <div class="player-info">
            <span class="player-name">{{ i + 1 }}. {{ player.name }}</span>
            <p-tag 
              *ngIf="player.answeredAt" 
              value="Respondió" 
              [severity]="player.answeredCorrect ? 'warn' : 'danger'"
              size="small"
            ></p-tag>
          </div>
          <div class="player-score">
            <span class="score-value">{{ player.score }}</span>
            <span class="score-label">pts</span>
          </div>
        </div>
      </div>
      
      <div *ngIf="playersCount === 0" class="empty-state">
        <i class="pi pi-users empty-icon"></i>
        <p class="empty-title">No hay jugadores conectados aún</p>
        <p class="empty-subtitle">Genera el código para que los jugadores se unan</p>
      </div>
    </div>
  </p-card>

  <!-- Estado del juego -->
  <p-card header="Estado del Juego" *ngIf="roomState?.isActive" class="game-state-card">
    <div class="game-state-grid">
      <div class="game-info">
        <div class="game-item">
          <span class="game-label">Ronda actual:</span>
          <p-tag [value]="currentRound.toString()" severity="info"></p-tag>
          <span class="game-detail">de {{ totalQuestions }}</span>
        </div>
        <div class="game-item">
          <span class="game-label">Respondieron:</span>
          <span class="game-detail">{{ answeredCount }}/{{ playersCount }}</span>
        </div>
      </div>
      <div class="current-question" *ngIf="roomState?.currentQuestion">
        <h5 class="question-title">Pregunta Actual</h5>
        <p class="question-text">{{ roomState?.currentQuestion?.question }}</p>
        <div class="question-options">
          <div *ngFor="let option of roomState?.currentQuestion?.options" class="option-item">
            {{ option }}
          </div>
        </div>
      </div>
    </div>
  </p-card>

  <!-- Diálogo QR -->
  <p-dialog 
    header="Código QR de la Sala" 
    [(visible)]="showQRDialog" 
    [modal]="true" 
    [style]="{width: '400px'}"
    styleClass="light-qr-modal"
    [draggable]="false"
    [resizable]="false"
  >
    <div class="qr-dialog">
      <div class="qr-code">
        <div class="room-code">{{ roomId }}</div>
      </div>
      <p class="qr-description">
        Los jugadores pueden usar este código del el Room ID para unirse a la partida.
      </p>
      
    </div>
    
    <ng-template pTemplate="footer">
      <button 
        pButton 
        label="Cerrar" 
        icon="pi pi-times"
        class="p-button-outlined custom-bordo-button"
        (click)="showQRDialog = false"
      ></button>
    </ng-template>
  </p-dialog>
</div>
